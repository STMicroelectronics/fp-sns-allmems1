# ALLMEMS1 Application Description for STEVAL-STLKT01V1 (SensorTile) evaluation board

The ALLMEMS1 is an STM32 ODE function pack which lets you connect your IoT node to a smartphone via BLE and use a suitable AndroidT or iOST like the ST BLE Sensor app (Version 4.13.0 or higher),
you can visualize real-time environmental sensor data, motion sensor data, digital microphone level and battery level.
With this package you can record on SD card the enviromental sensor data, motion sensor data and digital microphone level.
The package also allows to perform advanced functionality such as voice communication over BLE, as well sensor data fusion and accelerometer-based real-time activity recognition,
gesture recognition, motion Intensity recognition. Moreover provides real-time information about: the user current pose based on data from a device, the user working mode (sitting at the desk or standing desk position),
the tilt angles of the user device, the repetition quantity of various fitness activities performed by a user, the vertical movement. 

This firmware package includes Components Device Drivers, Board Support Package and example application for the following STMicroelectronics elements:
 - STEVAL-STLKT01V1 (SensorTile) evaluation board that contains the following components:
   - MEMS sensor devices: HTS221, LPS22HB, LSM303AGR, LSM6DSM
   - digital microphone: MP34DT04
   - Gas Gauge IC with alarm output: STC3115
 - MotionAR software provides real-time activity recognition data using MEMS accelerometer sensor
 - MotionCP software provides carry Position recognition data using MEMS accelerometer sensor (Not enabled as default)
 - MotionFA software provides real-time information about the repetition quantity of various fitness activities performed by a user
 - MotionFX (iNEMOEngine PRO) suite uses advanced algorithms to integrate outputs
   from multiple MEMS sensors in a smartway, independent of environmental conditions,
   to reach optimal performance. Real-time motion-sensor data fusion is set to significantly
   improve the user experience, increasing accuracy, resolution, stability and response time.
 - MotionGR software provides carry Gesture recognition data using MEMS accelerometer sensor
 - MotionID software provides real-time Motion Intensity recognition data using MEMS accelerometer sensor
 - MotionPE software provides real-time information about the user current pose based on data from a device
 - MotionSD software provides real-time information about the user working mode (sitting at the desk or standing desk position)
 - MotionTL software provides real-time information about the tilt angles of the user device
 - MotionVC software provides real-time information about the vertical movement
 - BlueVoiceADPCM software enables real-time half-duplex voice-over-Bluetooth low energy communication profile.
   It includes one characteristic for audio transmission and one for synchronization and it is responsible for audio encoding and periodical data
   transmission on Server side and for decoding of received voice data on Client side
 - USB device library provides support of multi packet transfer to allow sending big amount of data without split 
   them into max packet size transfers.
 - FatFs generic FAT file system module provides access the storage devices such as memory card and hard disk.
 
The Example application initizializes all the Components and Library creating 3 Custom Bluetooth services:
 - The first service exposes all the HW and SW characteristics:
   - the HW characteristics related to MEMS sensor devices: related to MEMS sensor devices: Temperature, Humidity, Pressure, Magnetometer, Gyroscope, Accelleromenter
     and Microphones Signal Noise dB level.
   - battery Gas Gauge
   - SW characteristics:
       - the quaternions generated by the MotionFX library in short precision
       - the activity recognized using the MotionAR algorithm
       - the carry position recognized using the MotionCP algorithm (Not enabled as default)
       - the repetition quantity of various fitness activities performed by a user using the MotionFA algorithm
       - the Gesture recognized using the MotionGR algorithm
       - the Motion Intensity recognition using the MotionID algorithm
       - the user current pose based on data from a device using the MotionPE algorithm
       - the user working mode (sitting at the desk or standing desk position) using the MotionSD algorithm
       - the tilt angles of the user device using the MotionTL algorithm
       - the vertical movement using the MotionVC algorithm
	   - It uses BlueVoiceADPCM software for real-time half-duplex voice-over-Bluetooth low energy communication profile.
	   - FatFs generic FAT file system for SD card data logging for environmental, mens and audio data (for only SensorTile).
         This functionality on SensorTile board is enabled as default through the code line 
		   #define ALLMEMS1_ENABLE_SD_CARD_LOGGING
		 on file:
		   Projects\STM32L476RG-SensorTile\Applications\ALLMEMS1\Inc\ALLMEMS1_config.h
 - The second Service exposes the console services where we have stdin/stdout and stderr capabilities
 - The last Service is used for configuration purpose
 
For the STEVAL-STLKT01V1, when the Android/iOS device is not connected for more than 20 seconds, the board go on shutdown mode.
The shutdown mode can be enabled or disabled by means of the macro ENABLE_SHUT_DOWN_MODE
The accelerometer event can be selected and used to wake-up the board to connect it to Android/iOS again and it can be chosen by
the constant WakeupSource in the file main.c (The Double Tap event is set as default).
Through the define RANGE_TIME_WITHOUT_CONNECTED in main.h file it is possible modified this time value.

The example application allows the user to control the initialization phase via UART.
Launch a terminal application and set the UART port to 9600 bps, 8 bit, No Parity, 1 stop bit.

For having the same UART functionality on SensorTile board, is necessary to recompile the code uncomment the line
  //#define ALLMEMS1_ENABLE_PRINTF
on file:
  Projects\STM32L476RG-SensorTile\Applications\ALLMEMS1\Inc\ALLMEMS1_config.h
and if not enabled the SD card data logging functionality.
This enables the UART that starts with a delay of 10 Seconds for allowing the time to open the UART for looking the initialization phase.
 
This example must be used with the related ST BLE Sensor Android (Version 4.13.0 or higher) or iOS (Version 4.11.0 or higher) application available on Play/itune store,
in order to read the sent information by Bluetooth Low Energy protocol

## Very Important

The implementation allow the Firmware-Over-The-Air (FOTA).
 
 1) The Firmware-Over-The-Air (FOTA) is done using the ST BLE Sensor Android/iOS application (Version 4.13.0 and above)
 
 2) This example must run starting at address 0x08004000 in memory and works ONLY if the BootLoader 
 is saved at the beginning of the FLASH (address 0x08000000)
 
 3) For each IDE (IAR/µVision/STM32CubeIDE) there are some scripts *.bat/*.sh that makes the following operations:
    - Full Flash Erase
    - Load the BootLoader on the rigth flash region
    - Load the Program (after the compilation) on the rigth flash region (This could be used for a FOTA)
    - Dump back one single binary that contain BootLoader+Program that could be 
      flashed at the flash beginning (address 0x08000000) (This COULD BE NOT used for FOTA)
    - Reset the board
	
## Issue

- Due to ram size constraints MotionCP is not enable as default (Only if the MotionFA is disabled MotionCP will be enable).
  For enabling MotionCP library it is necessary to recompile the code comment the line
    #define ALLMEMS1_MOTIONFA
  on file:
	Projects\Multi\Applications\ALLMEMS1\Inc\ALLMEMS1_config.h
- Led features is not enabled for SensorTile when SD card logging feature is enabled and during the recording only
 (The led will blink during the data logging only).
- A compiler warning is generated from STM32 Audio Library middlewares when using the library in IAR v 9.x and STM32CubeIDE.
  It doesn't affect library performances.
- A compiler warning "L6989W: Could not apply patch sdcomp-29491-629360 to instruction VPOP" is generated from µVision toolchain.
  Some members of the STM32L4 family have an eratta for the FMC (Flexible Memory Controller) where a read burst access of 9 words or more is not supported by FMC.
  To prevent burst accesses that are greater than 8 words, a special linker patch was developed to patch certain instructions that result in burst accesses of greater
  than 8 words. The patch can be applied in most cases with a few exceptions.
  One of these exceptions is when the instruction to be patched is inside an IT (If-Then) block and is not the last instruction in that block.
  In this case this warning will be generated.
  Since the FMC is only used for external memory, you can ignore this warning if you are only using internal memory.

## Known Limitation
 
- Even if FP-SNS-ALLMEMS1 send 100 quaternions/second with Bluetooth, the mobile devices could render only 60 frames/second
- The SensorTile hardware components use SPI 3 wire connentions.
  STM32CubeMX does not support the SPI 3 wire connection.
  For this reason, the file .ioc cannot generate.

## Dependencies

STM32Cube packages:
  - STM32L4xx drivers from STM32CubeL4 V1.17.1
  
X-CUBE packages:
  - X-CUBE-BLE1 V6.2.2
  - X-CUBE-MEMS1 V9.1.0
@par FP packages:
  - STSW-STLKT01 V2.1.6

## Hardware and Software environment

- This example runs on STEVAL-STLKT01V1 (SensorTile) evaluation board
- This example must be used with the related ST BLE Sensor Android/iOS application (Version 4.13.0/4.11.0 or higher) available on Play/itune store, in order to read the sent information by Bluetooth Low Energy protocol.
- Inside the Binary Directory there are the following binaries:
    - STM32L476JG-SensorTile_ALLMEMS1_v4.2.0.bin    (Program without BootLoader. COULD BE USED     for FOTA)
    - STM32L476JG-SensorTile_ALLMEMS1_v4.2.0_BL.bin (Program with BootLoader.    COULD NOT BE USED for FOTA)

## How to use it ?

This package contains projects for 3 IDEs viz. IAR, Keil µVision 5 and Integrated Development Environment for STM32. 
In order to make the  program work, you must do the following:
 - WARNING: before opening the project with any toolchain be sure your folder
   installation path is not too in-depth since the toolchain may report errors
   after building.

For IAR:
 - Open IAR toolchain (this firmware has been successfully tested with Embedded Workbench V9.20.1).
 - Open the IAR project file EWARM\Project.eww
 - Rebuild all files and run CleanALLMEMS1_IAR_ST.bat script that you find on the same directory.

For Keil µVision 5:
 - Open Keil µVision 5 toolchain (this firmware has been successfully tested with MDK-ARM Professional Version: 5.32.0).
 - Open the µVision project file MDK-ARM\STM32L476JG-SensorTile_ALLMEMS1.uvprojx
 - Rebuild all files and run CleanALLMEMS1_MDK_ARM_ST.bat script that you find on the same directory.
 
For Integrated Development Environment for STM32:
 - Open STM32CubeIDE (this firmware has been successfully tested with Version 1.8.0).
 - Set the default workspace proposed by the IDE (please be sure that there are not spaces in the workspace path).
 - Press "File" -> "Import" -> "Existing Projects into Workspace"; press "Browse" in the "Select root directory" and choose the path where the System
   Workbench project is located (it should be STM32CubeIDE). 
 - Rebuild all files and and run these script that you find on the same directory:
   - if you are on windows and you had installed the STM32 ST-Link utility: CleanALLMEMS1_STM32CubeIDE_ST.bat
   - Otherwise (Linux/iOS or Windows with the STM32CubeProgrammer) run CleanALLMEMS1_STM32CubeIDE_ST.sh.
   
