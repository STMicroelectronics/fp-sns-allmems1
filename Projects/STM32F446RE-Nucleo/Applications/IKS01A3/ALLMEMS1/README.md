# ALLMEMS1 Application Description for STM32F446RE with X-NUCLEO-IKS01A3 expansion board

The ALLMEMS1 is an STM32 ODE function pack which lets you connect your IoT node to a smartphone via BLEand use a suitable AndroidT or iOST like the ST BLE Sensor app (Version 4.13.0 or higher),
you can visualize real-time environmental sensor data, motion sensor data and digital microphone levels.
The package also allows to perform advanced functionality such as sound source localization using inputs from multiple microphones, as well sensor data fusion and accelerometer-based real-time activity recognition. 

This firmware package includes Components Device Drivers, Board Support Package and example application for the following STMicroelectronics elements:
 - X-NUCLEO-BNRG2A1 Bluetooth Low energy expansion boards
 - X-NUCLEO-IKS01A3 Expansion board for four MEMS sensor devices:
   - HTS221, LPS22HH, LSM6DSO, LIS2MDL
 - X-NUCLEO-CCA02M2 Digital MEMS microphones expansion board
 - NUCLEO-F446RE
 - The MotionFX (iNEMOEngine PRO) suite uses advanced algorithms to integrate outputs
 from multiple MEMS sensors in a smartway, independent of environmental conditions,
 to reach optimal performance. Real-time motion-sensor data fusion is set to significantly
 improve the user experience, increasing accuracy, resolution, stability and response time.
 - MotionAR (iNEMOEngine PRO) software provides real-time activity recognition data 
 using MEMS accelerometer sensor
 - AcousticSL software provides real-time audio source localization using PCM signal audio
 
The Example application initizializes all the Components and Library creating 3 Custom Bluetooth services:
 - The first service exposes all the HW and SW characteristics:
   - the HW characteristics related to MEMS sensor devices: Temperature, Humidity, Pressure, Magnetometer, Gyroscope and Accelleromenter
     and Microphones Signal Noise dB level. 
   - the SW characteristic: the quaternions generated by the MotionFX library in short precision,
     the activity recognized using the MotionAR algorithm, the audio source localization using the AcousticSL software that provides real-time audio
	 source localization.
 - The second Service exposes the console services where we have stdin/stdout and stderr capabilities
 - The last Service is used for configuration purpose

The example application allows the user to control the initialization phase via UART.
Launch a terminal application and set the UART port to 115200 bps, 8 bit, No Parity, 1 stop bit.
 
This example must be used with the related ST BLE Sensor Android (Version 4.13.0 or higher) or iOS (Version 4.11.0 or higher) application available on Play/itune store,
in order to read the sent information by Bluetooth Low Energy protocol

## Important Hardware Additional Information

1) For F4xx STM32 Nucleo motherboard, there is an hardware conflict between the X-NUCLEO-IKS01A3 expansion board and the X-NUCLEO-CCA02M2
   expansion board through the Arduino UNO R3 extension connector.
   The hardware conflict is onto 5,6 and 7 pin of the CN9 arduido connector.
   For X-NUCLEO-IKS01A3:
   - In the pin 5 (SB27) and 6 (SB26) there are the interrupts INT1 and INT2 for LSM6DSL component (used for the feature hardware)
   - In the pin 7 (SB25) there is the interrupt for LPS22HB component
   For X-NUCLEO-CCA02M2:
   - In the pin 5 (SB7)  there is the clock for the Microphones
   - In the pin 6 (SB15) there is the clock x2 for the Microphones
   - In the pin 7 (SB17) there is the connection for the microphone PDM34 (solder bridge open as default)
   
   For this reason the hardware features are not available for F4xx STM32 Nucleo motherboard (The related gpio pins is not configured).
   
2) BlueNRG-2 library does not work with the stock firmware that is loaded in the BLE module of X-NUCLEO-BNRG2A1 expansion board.
   For this reason:
   - first of all, it is needed to solder on X-NUCLEO-BNRG2A1, if it is not soldered, a 0 Ohm resistor at R117
   - then you can use a standard ST-Link V2-1 with 5 jumper wires female-female together with STSW-BNRGFLASHER software tool
    (currently available only for Windows PC) in order to update the firmware of the BLE module of X-NUCLEO-BNRG2A1.
   Read user manual for more details. 

## Very Important

a) The implementation allow the Firmware-Over-The-Air (FOTA).
 
 1) The Firmware-Over-The-Air (FOTA) is done using the ST BLE Sensor Android/iOS application (Version 4.13.0 and above)
 
 2) This example must run starting at address 0x08004000 in memory and works ONLY if the BootLoader 
 is saved at the beginning of the FLASH (address 0x08000000)
 
 3) For each IDE (IAR/µVision/STM32CubeIDE) there are some scripts *.bat/*.sh that makes the following operations:
    - Full Flash Erase
    - Load the BootLoader on the rigth flash region
    - Load the Program (after the compilation) on the rigth flash region (This could be used for a FOTA)
    - Dump back one single binary that contain BootLoader+Program that could be 
      flashed at the flash beginning (address 0x08000000) (This COULD BE NOT used for FOTA)
    - Reset the board
	
b) If the user presses the blue user button on Nucleo board 3 times on less that 2 seconds, he forces a new
   Calibration for MotionFX Library (For avoiding accidental erasure of the calibration data).
   The calibration value could be stored on FLASH memory or in RAM for avoiding to do the calibration at each board reset

## Dependencies

STM32Cube packages:
  - STM32F4xx drivers from STM32CubeF4 V1.26.2
  
X-CUBE packages:
  - X-CUBE-BLE2 V3.2.2
  - X-CUBE-MEMS1 V9.1.0
  - X-CUBE-MEMSMIC1 V5.3.0

## Hardware and Software environment

- This example runs on Sensor expansion board attached to STM32F446RE devices can be easily tailored to any other supported device and development board.
- This example must be used with the related ST BLE Sensor Android/iOS application (Version 4.13.0/4.11.0 or higher) available on Play/itune store, in order to read the sent information by Bluetooth Low Energy protocol.
- Inside the Binary Directory there are the following binaries:
  - STM32F446RE-Nucleo_IKS01A3_ALLMEMS1_v4.2.0.bin				(Program without BootLoader. COULD BE USED     for FOTA)
  - STM32F446RE-Nucleo_IKS01A3_ALLMEMS1_BL_v4.2.0.bin			(Program with BootLoader.    COULD NOT BE USED for FOTA)

## How to use it ?

This package contains projects for 3 IDEs viz. IAR, Keil µVision 5 and Integrated Development Environment for STM32. 
In order to make the  program work, you must do the following:
 - WARNING: before opening the project with any toolchain be sure your folder
   installation path is not too in-depth since the toolchain may report errors
   after building.

For IAR:
 - Open IAR toolchain (this firmware has been successfully tested with Embedded Workbench V9.20.1).
 - Open the IAR project file EWARM\Project.eww
 - Rebuild all files and run these script that you find on the same directory:
   - CleanALLMEMS1_IAR_IKS01A3_F401.bat

For Keil µVision 5:
 - Open Keil µVision 5 toolchain (this firmware has been successfully tested with MDK-ARM Professional Version: 5.32.0).
 - Open the µVision project file MDK-ARM\STM32F446RE-Nucleo_IKS01A3_ALLMEMS1.uvprojx
 - Rebuild all files and run these script that you find on the same directory:
   - CleanALLMEMS1_MDK-ARM_IKS01A3_F401.bat
 
For Integrated Development Environment for STM32:
 - Open STM32CubeIDE (this firmware has been successfully tested with Version 1.8.0).
 - Set the default workspace proposed by the IDE (please be sure that there are not spaces in the workspace path).
 - Press "File" -> "Import" -> "Existing Projects into Workspace"; press "Browse" in the "Select root directory" and choose the path where the System
   Workbench project is located (it should be STM32CubeIDE). 
 - Rebuild all files and and run these script that you find on the same directory:
   - if you are on windows and you had installed the STM32 ST-Link utility:
	 - CleanALLMEMS1_STM32CubeIDE_IKS01A3_F401.bat
   - Otherwise (Linux/iOS or Windows without the STM32 ST-Link Utility):
	 - CleanALLMEMS1_STM32CubeIDE_IKS01A3_F401.sh
